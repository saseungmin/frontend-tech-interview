## 👉 Front-end

### 🎈 Yarn Berry를 사용하는 이유
Yarn Berry를 사용하는 이유는 기존에 사용했던 npm, yarn v1에서 발생하는 문제점이 존재하기 때문입니다.   

기존에 의존성을 `node_modules`를 통해 관리하였는데 npm은 패키지를 찾기 위해서 계속 상위 디렉토리의 `node_modules` 폴더를 탐색합니다. 따라서 패키지를 바로 찾지 못할수록 readdir, stat과 같은 느린 I/O 호출이 반복됩니다. 경우에 따라서는 I/O 호출이 중간에 실패하기도 합니다.   

npm은 패키지를 찾지 못하면 상위 디렉토리의 `node_modules` 폴더를 계속 검색합니다. 이 특성 때문에 어떤 의존성을 찾을 수 있는지는 해당 패키지의 상위 디렉토리 환경에 따라 달라집니다.   
예를 들어, 상위 디렉토리가 어떤 `node_modules`를 포함하고 있는지에 따라 의존성을 불러올 수 있기도 하고, 없기도 합니다. 다른 버전의 의존성을 잘못 불러올 수 있는 여지도 존재합니다.

또한 npm을 구성하는 `node_modules` 디렉토리 구조는 매우 큰 공간을 차지합니다. `node_modules` 폴더는 복잡하기 때문에 설치가 유효한지 검증하기 어렵습니다. 예를 들어, 수백 개의 패키지가 서로를 의존하는 복잡한 의존성 트리에서 `node_modules` 디렉토리 구조는 깊어집니다. 이렇게 깊은 트리 구조에서 의존성이 잘 설치되어 있는지 검증하려면 많은 수의 I/O 호출이 필요합니다. 일반적으로 디스크 I/O 호출은 메모리의 자료구조를 다루는 것보다 훨씬 느립니다. 이런 문제로 인해 yarn v1이나 npm은 기본적인 의존성 트리의 유효성까지만 검증하고, 각 패키지의 내용이 올바른지는 확인하지 않습니다.   

그리고 npm 및 yarn v1에서는 중복해서 설치되는 `node_modules`를 아끼기 위해 끌어올리기(Hoisting) 기법을 사용합니다. 끌어올리기에 따라 직접 의존하고 있지 않은 라이브러리를 require() 할 수 있는 현상을 유령 의존성(Phantom Dependency)이라고 부릅니다. 유령 의존성 현상이 발생할 때, package.json에 명시하지 않은 라이브러리를 조용히 사용할 수 있게 됩니다.   

yarn berry는 위에서 언급한 문제를 Plug’n’Play (PnP) 방법을 통해 해결합니다.   
yarn berry는 `node_modules`를 생성하지 않습니다. 대신 `.yarn/cache` 폴더에 의존성의 정보가 저장되고, `.pnp.cjs` 파일에 의존성을 찾을 수 있는 정보가 기록됩니다. `.pnp.cjs`를 이용하면 디스크 I/O 없이 어떤 패키지가 어떤 라이브러리에 의존하는지, 각 라이브러리는 어디에 위치하는지를 바로 알 수 있습니다.   

yarn berry의 PnP 시스템에서 각 의존성은 zip 아카이브로 관리됩니다. 이후 `.pnp.cjs` 파일이 지정하는 바에 따라 동적으로 zip 아카이브의 내용이 참조됩니다. zip 아카이브로 의존성을 관리하면 더 이상 `node_modules` 디렉토리 구조를 생성할 필요가 없기 때문에 설치가 신속히 완료되고, 각 패키지는 버전마다 하나의 zip 아카이브만을 가지기 때문에 중복해서 설치되지 않습니다. 그리고 의존성을 구성하는 파일의 수가 많지 않으므로, 변경 사항을 감지하거나 전체 의존성을 삭제하는 작업이 빠릅니다.   

yarn PnP는 `node_modules`에서와 같이 의존성을 끌어올리지 않습니다. 이로써 각 패키지들은 자신이 `package.json`에 기술하는 의존성에만 접근할 수 있습니다. 기존에 환경에 따라 우연히 작동할 수 있었던 코드들이 보다 엄격히 관리되는 것입니다. 이로써 예기치 못한 버그를 쉽게 일으키던 유령 의존성 현상을 근본적으로 막을 수 있습니다.    

yarn PnP은 의존성을 압축 파일로 관리하기 때문에 의존성의 용량이 작습니다. 또한 각 의존성은 하나의 zip 파일로만 표현되기 때문에 의존성을 구성하는 파일의 숫자가 npm만큼 많지 않습니다. 이처럼 용량과 파일의 숫자가 적기 때문에 yarn berry를 사용하면 의존성을 Git으로 관리할 수 있습니다. 이렇게 yarn berry에서 의존성을 버전 관리에 포함하는 것을 Zero-Install이라고 합니다.   

이처럼 의존성을 버전 관리에 포함하면 새로 저장소를 복제하거나 브랜치를 바꾸었다고 해서 yarn install을 실행하지 않아도 되고 이에 따라 CI에서 의존성 설치하는 시간을 크게 절약할 수 있습니다.

> https://toss.tech/article/node-modules-and-yarn-berry
